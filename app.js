function main(){function e(e){_Download.DLStart(e,function(e){1>e?_Log.log("Main",!1,"1曲DL","ダウンロード完了"):_Log.log("Main",!1,"全曲DL完了","全てのダウンロード完了。"),n()})}function n(){if(!_Player.isPlaying()){_Player.setIsPlaying(!0);var e=_TrackSelector.getTrack(_Download.getDownloadFileList());_Decrypto.decrypto(e,function(n){n?r(n):_Log.log("Main",!0,"バッファ無し","再生するバッファデータがありません。"+e)})}}function r(e){_Player.playFromDecBuff(e,function(e){_Log.log("Main",!1,"次曲再生","再生完了。次を再生"),n()})}_PlayList.getPlistInfo(url,function(n,r){n?_Log.log("Main",!0,"PL総合取得失敗","プレイリスト総合情報が取得に失敗\n"+n):_PlayList.getPlayList(r[0].fname,function(n,t){n?_Log.log("Main",!0,"PL取得失敗","プレイリスト取得に失敗："+r[0].fname+"\nエラーメッセージ：\n"+n):(_Log.log("Main",!1,"PL取得","プレイリスト：["+r[0].fname+"] "+t.length+"件"),e(t))})})}var _RepStrUtil=new function(){function e(e){if(!e)return 0;for(len=0,e=escape(e),i=0;i<e.length;i++,len++)"%"==e.charAt(i)&&("u"==e.charAt(++i)&&(i+=3,len++),i++);return len}return{Rep_htmlAttribute:function(e){return e?e.replace(/"/g,"&quot;"):""},Rep_htmlText:function(e){return e?e.replace(/</g,"&lt;").replace(/>/g,"&gt;"):""},Rep_webSQLjs:function(e){return e?e.replace(/'/g,"＜REP:’＞").replace(/%/g,"＜REP:％＞"):""},deRep_webSQLjs:function(e){return e?e.replace(/＜REP:’＞/g,"'").replace(/＜REP:％＞/g,"%"):""},Rep_filePath:function(e){return e?e.replace(/\\/g,"\\"):""},Rep_newRegExp:function(e){return e?e.replace(/\\/g,"\\\\").replace(/\^/g,"\\^").replace(/\$/g,"\\$").replace(/\*/g,"\\*").replace(/\?/g,"\\?").replace(/\)/g,"\\)").replace(/\(/g,"\\(").replace(/\./g,"\\.").replace(/\(\?\:/g,"\\(\\?\\:").replace(/\(\?\=/g,"\\(\\?\\=").replace(/\(\?\!/g,"\\(\\?\\!").replace(/\|/g,"\\|").replace(/\{/g,"\\{").replace(/\}/g,"\\}").replace(/\[/g,"\\[").replace(/\]/g,"\\]"):""},Rep_AddPriceComma:function(e){return e?String(e).replace(/(\d)(?=(\d\d\d)+(?!\d))/g,"$1,"):""},Rep_numZeroPadding:function(e,n){var r=e;r||(r=0);for(var t="",o=0;n>o;o++)t+="0";return(t+String(r)).slice(-1*n)},Rep_SpacePaddingString:function(n,r){var t=n;t||(t=""),t=String(t);var o=e(t),i="",a=r-o;0>a&&(a=0);for(var l=0;a>l;l++)i+=" ";return t+i},Rep_HEXColorToRGBColor:function(e){if(e&&""!=e){if(4==e.length)var n=e.match(/^#([0-9a-fA-F]{1})([0-9a-fA-F]{1})([0-9a-fA-F]{1})/),r=n[1]+n[1],t=n[2]+n[2],o=n[3]+n[3];else{if(7!=e.length)return null;var i=e.match(/^#([0-9a-fA-F]{2})([0-9a-fA-F]{2})([0-9a-fA-F]{2})/),r=i[1],t=i[2],o=i[3]}var a=parseInt(r,16),l=parseInt(t,16),u=parseInt(o,16);return"rgb("+a+", "+l+", "+u+")"}return null},getCharCount:function(n){return n?e(n):0}}},_Log=new function(){function e(e){return"black"==e?"[30m":"red"==e?"[31m":"green"==e?"[32m":"yellow"==e?"[33m":"blue"==e?"[34m":"magenta"==e?"[35m":"cyan"==e?"[36m":"white"==e?"[37m":"[0m"}function n(){var e=new Array("日","月","火","水","木","金","土"),n=new Date,r=n.getYear(),t=n.getMonth()+1,o=n.getDate(),i=(e[n.getDay()],n.getHours()),a=n.getMinutes(),l=n.getSeconds();return 2e3>r&&(r+=1900),10>t&&(t="0"+t),10>o&&(o="0"+o),10>i&&(i="0"+i),10>a&&(a="0"+a),10>l&&(l="0"+l),r+"/"+t+"/"+o+" "+i+":"+a+":"+l}var r=[],t=!0;return{log:function(o,i,a,l){var u=!0;if(r&&r.length>0){u=!1;for(var c=0;c<r.length;c++)if(r[c]==o){u=!0;break}}if(u){var f=_RepStrUtil.Rep_SpacePaddingString(o,16),g=_RepStrUtil.Rep_SpacePaddingString(a,16),s=t?n():"";i?console.error(" "+e("red")+s+" "+e("cyan")+f+e()+e("white")+g+e()+e("red")+l+e()):console.log(" "+s+" "+e("cyan")+f+e()+e("white")+g+e()+l)}},setFilterModuleName:function(e){r=e},isVisibleDate:function(e){t=e}}},_WriteFile=new function(){var e=require("fs"),n=require("mkdirp"),r=require("path").dirname;return{write:function(t,o,i){n(r(t),function(n){return n?i(n):void e.writeFile(t,o,i)})},writeFromBuffer:function(t,o,i){n(r(t),function(n){return n?i(n):void e.open(t,"w",function(n,r){return n?i(n):void e.write(r,o,0,o.length,0,function(n){return n?i(n):void e.close(r,function(){i(null)})})})})}}},_ProcessTimeINST=new function(){function e(e){var n=Math.floor(e/36e5),r=Math.floor((e-36e5*n)/6e4),t=Math.floor((e-36e5*n-6e4*r)/1e3),o=e-36e5*n-6e4*r-1e3*t;return n+"h "+r+"m "+t+"s "+o+"ms ("+e+"ms)"}function n(){a=new Date,a=o.getTime()}function r(){o=new Date,i=o.getTime()}function t(){o=new Date,l=o.getTime()}var o,i,a,l;return{startTimerINSTL:function(){r(),n()},getTotalTimerINSTL:function(){t();var n=l-a;return[n,e(n)]},getTimerINSTL:function(){t();var n=l-i;return r(),[n,e(n)]}}},_CryptAsync=new function(){function e(e){var n=g.createCipher(s,p),r=Buffer.concat([n.update(e),n["final"]()]);return r}function n(e){var n=g.createDecipher(s,p),r=Buffer.concat([n.update(e),n["final"]()]);return r}function r(e,n,r){_WriteFile.writeFromBuffer(e,n,r)}function t(n,t,o){c.readFileAsync(n).then(function(n){var i=e(n);r(t,i,o)})}function o(e,t,o){c.readFileAsync(e).then(function(e){var i=n(e);r(t,i,o)})}function i(e,r){c.readFileAsync(e).then(function(e){var t=n(e);r(t)})}function a(e,n,r){f.resolve().then(function(){return f.all([new f(function(o,i){setTimeout(function(){t(e,n,function(e){e?(r(e),i()):(r(e),o())})},100)})])})}function l(e,n,r){f.resolve().then(function(){return f.all([new f(function(t,i){setTimeout(function(){o(e,n,function(e){e?(r(e),i()):(r(e),t())})},100)})])})}function u(e,n){f.resolve().then(function(){return f.all([new f(function(r,t){setTimeout(function(){i(e,function(e){n(e),r()})},100)})])})}var c=require("fs"),f=require("bluebird"),g=require("crypto"),s="aes-256-ctr",p="password";return c=f.promisifyAll(c),g=f.promisifyAll(g),{setting:function(e,n){s=n,p=e},encryptFile:function(e,n,r){a(e,n,r)},decryptFile:function(e,n,r){l(e,n,r)},decryptFileToBuffer:function(e,n){u(e,n)}}},_Decrypto=new function(){function e(e,n){_ProcessTimeINST.startTimerINSTL(),_Log.log("_Decrypto",!1,"復号開始","./tmpF/m/"+e),_CryptAsync.decryptFileToBuffer("./tmpF/m/"+e,function(r){r?(_Log.log("_Decrypto",!1,"復号完了",_ProcessTimeINST.getTimerINSTL()[1]),n(r)):(_Log.log("_Decrypto",!0,"復号失敗","ファイルの復号に失敗しました。"+e),n(null))})}return{decrypto:function(n,r){return e(n,r)}}},_TrackSelector=new function(){function e(e){for(var n,r,t=e.length;t;)r=Math.floor(Math.random()*t--),n=e[t],e[t]=e[r],e[r]=n;return _Log.log("_TrackSelector",!1,"曲シャッフル","曲順をシャッフルしました"),e}function n(n){for(var t=0;t<n.length;t++)if(n[t].downloaded&&!n[t].played)return n[t].played=!0,r(n[t]),n[t].path;n=e(n);for(var t=0;t<n.length;t++)n[t].played=!1;return n[0].played=!0,r(n[0]),n[0].path}function r(e){t.nowPlaying=e}var t={nowPlaying:""};return{suffle:function(n){return e(n)},getTrack:function(e){return n(e)},getPlayingInfo:function(){return t}}},_PlayList=new function(){function e(e,n){r(e,function(r,t,o){var i="./tmpF/plist/plist.if";r||200!=t.statusCode?(_Log.log("_PlayList",!0,"総合PL接続失敗","総合プレイリスト情報にアクセス失敗しました。\nURL:"+e+"\nメッセージ:\n"+r),n(!0,null)):(_Log.log("_PlayList",!1,"総合PL取得","総合プレイリスト情報を取得"),_WriteFile.write(i,o,function(e){e?_Log.log("_PlayList",!0,"総合PL保存失敗","総合プレイリスト情報保存に失敗しました。\nメッセージ:\n"+e):_Log.log("_PlayList",!1,"総合PL保存","総合プレイリスト情報保存完了。"+i)}),n(null,JSON.parse(o)))})}function n(e,n){var t={uri:url+"/plist",json:{fname:e},method:"post"};r(t,function(r,o,i){if(r||200!=o.statusCode)_Log.log("_PlayList",!0,"PL接続失敗","プレイリスト情報にアクセス失敗しました。\nURL:"+t.uri+"\nメッセージ:\n"+r),n(!0,null);else{var a="./tmpF/plist/"+e+".p";_WriteFile.write(a,JSON.stringify(i),function(r){if(r)_Log.log("_PlayList",!0,"PL保存失敗","プレイリスト保存に失敗\nfile:"+e+"\nメッセージ:"+r),n(!0,null);else{var t=JSON.parse(JSON.stringify(i));_Log.log("_PlayList",!1,"PL保存","プレイリストの保存完了:"+t.playListTitle+"("+e+")");for(var o=[],a=0;a<t.playList.length;a++)o.push({path:t.playList[a].outPath,downloaded:!1,played:!1,info:t.playList[a]});n(null,o)}})}})}var r=require("request");return{getPlistInfo:function(n,r){e(n,r)},getPlayList:function(e,r){n(e,r)}}},_Download=new function(){function e(e,r){a=e,i=r,n()}function n(){l("./tmpF/m/**/**.dm",function(e,n){e?(console.error(e),_Log.log("_Download",!0,"ローカルデータ無し","ローカルに保存しているデータは見つかりません。"+e)):(f=n,_Log.log("_Download",!1,"キャッシュ有り","ローカルに保存データを"+f.length+"件確認"),c=-1,r())})}function r(){if(c++,c<a.length){for(var e=!1,n=0;n<f.length;n++)if(u.basename(a[c].path)==u.basename(f[n])){e=!0;break}e?(_Log.log("_Download",!1,"キャッシュ済",a[c].path),a[c].downloaded=!0,t()):o(a[c].path)}else _Log.log("_Download",!1,"全DL完了","全てのダウンロードが完了"),i((c+1)/a.length)}function t(){i((c+1)/a.length),r()}function o(e){s=null,s=g.fork("./child_download"),s.once("message",function(n){var r=n.state;r?(_Log.log("_Download",!1,"DL完了","ダウンロードに成功:"+e),a[c].downloaded=!0,t()):(_Log.log("_Download",!1,"DL失敗","ダウンロードに失敗:"+e),t())}),s.on("error",function(e){_Log.log("_Download",!0,"子プロセス・エラー","ダウンロード・プロセスに問題が発生しました。"+e)}),s.send({processName:"dl",file:e,url:url})}var i,a,l=require("glob"),u=require("path"),c=(require("request"),require("request-promise"),0),f=[],g=require("child_process"),s=g.fork("./child_download");return{DLStart:function(n,r){e(n,r)},getDownloadFileList:function(){return a}}},_Player=new function(){function e(e,g){e?(t=e,setTimeout(function(){r=null,r=new a.PassThrough,l=null,l=new o.Decoder,u=null,u=new i,r.end(t),r.pipe(l).on("error",function(){_Log.log("_Player stream",!0,"error",""),n(null,g)}).on("close",function(){_Log.log("_Player stream",!1,"close","")}).on("unpipe",function(){_Log.log("_Player stream",!1,"unpipe","")}).on("end",function(){_Log.log("_Player stream",!1,"end","")}).pipe(u).on("finish",function(){_Log.log("_Player stream",!1,"finish",""),n(null,g)}),_Log.log("_Player",!1,"再生開始",""),c=!0,f=new Date,f=f.getTime()},500)):e||_Log.log("_Player",!0,"バッファ無し","再生できるバッファがありません")}function n(e,n){c=!1,f=0,n(e)}var r,t,o=require("lame"),i=require("speaker"),a=require("stream"),l=new o.Decoder,u=new i,c=!1,f=0;return{playFromDecBuff:function(n,r){e(n,r)},isPlaying:function(){return c},setIsPlaying:function(e){c=e},getPlayingTimeSec:function(){if(0==f)return 0;var e=new Date;return(e.getTime()-f)/1e3}}},_Server=new function(){var e=require("fs"),n=require("body-parser"),r=require("express"),t=r();t.use(n.json());var o=require("ejs"),i=e.readFileSync(__dirname+"/template/ejs/index.ejs","utf-8"),a="application/json";t.use("/asset",r["static"](__dirname+"/template/ejs/asset")),t.use("/fonts",r["static"](__dirname+"/template/ejs/fonts")),t.get("/",function(e,n){var r=_TrackSelector.getPlayingInfo(),t=o.render(i,{nowPlaying:{artist:r.nowPlaying.info.artist,title:r.nowPlaying.info.title,year:r.nowPlaying.info.year,album:r.nowPlaying.info.album,comment:r.nowPlaying.info.comment,duration:r.nowPlaying.info.duration,playTime:_Player.getPlayingTimeSec(),lyric:_RepStrUtil.Rep_htmlText(r.nowPlaying.info.lyric).replace(/\n/g,"<br>")}});a="text/html",n.writeHead(200,{"Content-Type":a,"Access-Control-Allow-Origin":"*",Pragma:"no-cache","Cache-Control":"no-cache"}),n.end(t)});var l=process.env.port||1340;t.listen(l),console.log("server started on port "+l)},fs=require("fs"),glob=require("glob"),request=require("request"),CryptoJS=require("crypto-js"),lame=require("lame"),Speaker=require("speaker"),stream=require("stream"),mkdirp=require("mkdirp"),getDirName=require("path").dirname,path=require("path"),bodyParser=require("body-parser"),express=require("express"),app=express();app.use(bodyParser.json());var obj,bufferStream,decoder=new lame.Decoder,speaker=new Speaker,url="http://192.168.11.6:1338",_trackStack=[];main();